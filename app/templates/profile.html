{% extends "home.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <!-- Profile Card -->
            <div class="card shadow">
                <!-- Avatar View -->
                <div class="card-header bg-primary text-white text-center py-4">
                    <div class="d-flex justify-content-center mb-3">
                        {% if user.image_file != 'default.jpg' %}
                        <div class="position-relative">
                            <img src="{{ url_for('static', filename='profile_pics/' + user.image_file) }}"
                                class="rounded-circle border border-3 border-light shadow" alt="Profile Picture"
                                width="130" height="130">
                            <span class="position-absolute bottom-0 end-0">
                                <label for="{{ form.avatar.id }}" class="btn btn-sm btn-light rounded-circle shadow-sm"
                                    data-bs-toggle="tooltip" title="Change avatar">
                                    <i class="bi bi-camera-fill"></i>
                                </label>
                            </span>
                        </div>
                        {% else %}
                        <div class="position-relative">
                            <img src="{{ url_for('static', filename='profile_pics/default.png') }}"
                                class="rounded-circle border border-3 border-light shadow" alt="Default Avatar"
                                width="130" height="130">
                            <span class="position-absolute bottom-0 end-0">
                                <label for="{{ form.avatar.id }}" class="btn btn-sm btn-light rounded-circle shadow-sm"
                                    data-bs-toggle="tooltip" title="Change avatar">
                                    <i class="bi bi-camera-fill"></i>
                                </label>
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <h3 class="mb-1">{{ user.display_name or 'Your Name' }}</h3>
                    <p class="text-light mb-0">
                        <i class="bi bi-envelope-fill me-1 small"></i>
                        {{ user.email or 'your-email@example.com' }}
                    </p>
                </div>

                <!-- Profile Form -->
                <div class="card-body p-4">
                    <form method="POST" action="/profile" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}

                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <!-- Username -->
                                <div class="mb-3">
                                    {{ form.username.label(class_="form-label fw-bold") }}
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-person-fill"></i>
                                        </span>
                                        {{ form.username(class_="form-control", placeholder="Enter your username") }}
                                    </div>
                                </div>

                                <!-- Display Name -->
                                <div class="mb-3">
                                    {{ form.display_name.label(class_="form-label fw-bold") }}
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-card-heading"></i>
                                        </span>
                                        {{ form.display_name(class_="form-control", placeholder="Enter your display
                                        name") }}
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <!-- Email -->
                                <div class="mb-3">
                                    {{ form.email.label(class_="form-label fw-bold") }}
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-envelope"></i>
                                        </span>
                                        {{ form.email(class_="form-control", placeholder="Enter your email address") }}
                                    </div>
                                </div>

                                <!-- Hidden Avatar Upload -->
                                <div class="mb-3 d-none">
                                    {{ form.avatar(class_="form-control", accept=".jpg, .jpeg, .png") }}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Profile Picture</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light">
                                            <i class="bi bi-image"></i>
                                        </span>
                                        <input type="text" class="form-control" placeholder="No file selected"
                                            id="file-name" readonly>
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="document.getElementById('{{ form.avatar.id }}').click()">
                                            Browse
                                        </button>
                                    </div>
                                    <small class="text-muted">Upload a .jpg or .png image (max size: 2MB)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Bio -->
                        <div class="mb-4">
                            {{ form.bio.label(class_="form-label fw-bold") }}
                            <div class="input-group">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-file-text"></i>
                                </span>
                                {{ form.bio(class_="form-control", rows=4, placeholder="Write something about
                                yourself...") }}
                            </div>
                        </div>

                        <!-- Keys Section in Card -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-key me-2"></i>Encryption Keys</h5>
                            </div>
                            <div class="card-body">
                                <!-- Public Key Section -->
                                <div class="mb-4">
                                    <label for="publicKey" class="form-label fw-bold">Public Key</label>
                                    <div class="input-group">
                                        <textarea id="publicKey" class="form-control" rows="3"
                                            readonly>{{ user.public_key }}</textarea>
                                        <button class="btn btn-outline-primary d-flex align-items-center" type="button"
                                            onclick="copyToClipboard('publicKey')" data-bs-toggle="tooltip"
                                            data-bs-placement="top" title="Copy to clipboard">
                                            <i class="bi bi-clipboard me-2"></i>Copy
                                        </button>
                                    </div>
                                    <small class="text-muted mt-1">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Share this key with others so they can send you encrypted messages.
                                    </small>
                                </div>

                                <!-- Private Key Section -->
                                <div class="mb-3">
                                    <label for="privateKey" class="form-label fw-bold">Private Key</label>
                                    <div class="input-group">
                                        <textarea id="privateKey" class="form-control" rows="3"
                                            readonly>{{ user.private_key }}</textarea>
                                        <button class="btn btn-outline-primary d-flex align-items-center" type="button"
                                            onclick="copyToClipboard('privateKey')" data-bs-toggle="tooltip"
                                            data-bs-placement="top" title="Copy to clipboard">
                                            <i class="bi bi-clipboard me-2"></i>Copy
                                        </button>
                                    </div>
                                    <small class="text-muted mt-1">
                                        <i class="bi bi-lock-fill text-warning me-1"></i>
                                        Keep this key secure. Never share it with anyone.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="d-grid gap-2">
                            {{ form.submit(class_="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>

                <!-- Card Footer -->
                <div class="card-footer bg-light text-center py-3">
                    <small class="text-muted">Last updated: {{ user.last_updated.strftime('%B %d, %Y') if
                        user.last_updated else 'Never' }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // File name display for avatar upload
    document.getElementById('{{ form.avatar.id }}').addEventListener('change', function () {
        const fileName = this.files[0] ? this.files[0].name : 'No file selected';
        document.getElementById('file-name').value = fileName;
    });

    // Copy to clipboard function with visual feedback
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();

        navigator.clipboard.writeText(element.value)
            .then(() => {
                // Change button to show confirmation
                const button = element.nextElementSibling;
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check2 me-2"></i>Copied!';
                button.classList.replace('btn-outline-primary', 'btn-success');

                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.replace('btn-success', 'btn-outline-primary');
                }, 2000);
            })
            .catch(err => {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                document.execCommand('copy');
            });
    }

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}